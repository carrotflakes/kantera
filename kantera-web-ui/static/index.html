<!DOCTYPE html>
<html>
  <head>
    <title>kantera</title>
    <style>
      #editor {
        height: 20em;
      }
    </style>
  </head>
  <body>
    <button onClick="connect()">connect</button>
    <button onClick="apply()">apply</button>
    <div id="status"></div>
    <div id="editor">hello</div>
    <img id="img"/>
    <script src="https://pagecdn.io/lib/ace/1.4.6/ace.js" integrity="sha256-CVkji/u32aj2TeC+D13f7scFSIfphw2pmu4LaKWMSY8=" crossorigin="anonymous"></script>
    <script>
      const editor = ace.edit("editor");
      editor.setTheme("ace/theme/Chrome");
      editor.session.setMode("ace/mode/lisp");
      editor.commands.addCommand({
        name: 'apply',
        bindKey: {win: 'Ctrl-Return',  mac: 'Command-Return'},
        exec: function(editor) {
            apply();
        },
        readOnly: true
      });

      const statusEl = document.getElementById('status');
      const imgEl = document.getElementById('img');
      let ws = null;
      let syncObj = {frame: 0};

      function connect() {
        if (ws) {
          ws.close();
          ws = null;
          return;
        }
        ws = new WebSocket('ws://' + location.host + '/ws/');
        const history = [Date.now()];
        let readyToDraw = true;
        imgEl.onload = () => {
          readyToDraw = true;
        };
        ws.onopen = () => {
          console.log('connected');
        };
        ws.onmessage = e => {
          if (e.data instanceof Blob) {
            if (readyToDraw) {
              imgEl.src = (window.URL || window.webkitURL).createObjectURL(e.data);
              readyToDraw = false;
              history.push(Date.now());
              if (history.length > 30) history.shift();
            } else {
              console.log('frame skipped');
            }
          } else if (typeof e.data === 'string') {
            const data = JSON.parse(e.data);
            if (data.type === 'sync') {
              syncObj = {...syncObj, ...data, type: undefined};
            }
          } else {
            console.log(e.data);
          }
          statusEl.textContent = (history.length / Math.max(1, history[history.length - 1] - history[0]) * 1000 + '').substr(0, 5) + ' fps, ' + syncObj.frame + ' frame';
        };
        ws.onclose = () => {
          console.log('closed');
        };
      }

      function apply() {
        if (!ws) return;
        ws.send(editor.getValue());
      }
    </script>
  </body>
</html>
