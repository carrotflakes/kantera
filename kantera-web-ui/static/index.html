<!DOCTYPE html>
<html>
  <head>
    <title>kantera</title>
    <style>
      #editor {
        height: 20em;
      }
    </style>
  </head>
  <body>
    <button id="connectButton"onClick="connect()">connect</button>
    <button onClick="apply()">apply</button>
    <form>
      <input type="file" id="uploadFile" name="file"/>
      <input type="button" id="uploadButton" value="Submit"></button>
    </form>
    <div id="editor"></div>
    <div id="parseError" style="color: red"></div>
    <div id="status"></div>
    <img id="img"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js" integrity="sha256-XmdRbTre/3RulhYk/cOBUMpYlaAp2Rpo/s556u0OIKk=" crossorigin="anonymous"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.6/ace.js" integrity="sha256-CVkji/u32aj2TeC+D13f7scFSIfphw2pmu4LaKWMSY8=" crossorigin="anonymous"></script>
    <script>
      const editor = ace.edit("editor");
      editor.setTheme("ace/theme/chrome");
      editor.session.setMode("ace/mode/lisp");
      editor.commands.addCommand({
        name: 'apply',
        bindKey: {win: 'Ctrl-Return',  mac: 'Command-Return'},
        exec: function(editor) {
            apply();
        },
        readOnly: true
      });
      editor.session.on('change', delta => {
      });
      editor.setValue(localStorage.getItem('kantera-web-ui/code') || '');
      window.addEventListener('unload', e => {
        localStorage.setItem('kantera-web-ui/code', editor.getValue());
      });
      document.getElementById('uploadButton').onclick = async e => {
        const params = new FormData();
        params.append('file', document.getElementById('uploadFile').files[0]);
        const res = await axios.post('/upload', params, {headers: {'content-type': 'multipart/form-data'}});
        console.log(res);
        editor.setValue(res.data.map(fp => `(set image (import_image ${JSON.stringify(fp)}))`).join('\n') + '\n' + editor.getValue());
      };

      const statusEl = document.getElementById('status');
      const imgEl = document.getElementById('img');
      let ws = null;
      let syncObj = {frame: 0};

      function connect() {
        if (ws) {
          ws.close();
          return;
        }
        ws = new WebSocket('ws://' + location.host + '/ws/');
        const history = [Date.now()];
        let readyToDraw = true;
        imgEl.onload = () => {
          readyToDraw = true;
        };
        ws.onopen = () => {
          console.log('connected');
          document.getElementById('connectButton').textContent = 'disconnect';
        };
        ws.onmessage = e => {
          if (e.data instanceof Blob) {
            if (readyToDraw) {
              imgEl.src = (window.URL || window.webkitURL).createObjectURL(e.data);
              readyToDraw = false;
              history.push(Date.now());
              if (history.length > 30) history.shift();
            } else {
              console.log('frame skipped');
            }
          } else if (typeof e.data === 'string') {
            const data = eval('(' + e.data + ')'); // for parse "\'"
            if (data.type === 'sync') {
              syncObj = {...syncObj, ...data, type: undefined};
            } else if (data.type === 'parseFailed') {
              document.getElementById('parseError').textContent = data.error;
            }
          } else {
            console.log(e.data);
          }
          statusEl.textContent = (history.length / Math.max(1, history[history.length - 1] - history[0]) * 1000 + '').substr(0, 5) + ' fps, ' + syncObj.frame + ' frame';
        };
        ws.onclose = () => {
          ws = null;
          console.log('closed');
          document.getElementById('connectButton').textContent = 'connect';
        };
      }

      function apply() {
        if (!ws) return;
        document.getElementById('parseError').textContent = '';
        ws.send(editor.getValue());
      }
    </script>
  </body>
</html>
